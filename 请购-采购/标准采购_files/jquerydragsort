(function(n){n.fn.dragsort=function(t){if(t=="destroy"){n(this.selector).trigger("dragsort-uninit");return}var r=n.extend({},n.fn.dragsort.defaults,t),u=[],i=null,f=null;return this.each(function(t,e){n(e).is("table")&&n(e).children().size()==1&&n(e).children().is("tbody")&&(e=n(e).children().get(0));var o={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:e,init:function(){r.tagName=n(this.container).children().size()==0?"li":n(this.container).children().get(0).tagName.toLowerCase(),r.itemSelector==""&&(r.itemSelector=r.tagName),r.dragSelector==""&&(r.dragSelector=r.tagName),r.placeHolderTemplate==""&&(r.placeHolderTemplate="<"+r.tagName+">&nbsp;<\/"+r.tagName+">"),n(this.container).attr("data-listidx",t).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit),this.styleDragHandlers(!0)},uninit:function(){var t=u[n(this).attr("data-listidx")];n(t.container).unbind("mousedown",t.grabItem).unbind("dragsort-uninit"),t.styleDragHandlers(!1)},getItems:function(){return n(this.container).children(r.itemSelector)},styleDragHandlers:function(t){this.getItems().map(function(){return n(this).is(r.dragSelector)?this:n(this).find(r.dragSelector).get()}).css("cursor",t?"pointer":"")},grabItem:function(t){var f=u[n(this).attr("data-listidx")],s=n(t.target).closest("[data-listidx] > "+r.tagName).get(0),h=f.getItems().filter(function(){return this==s}).size()>0,i,o,e;if(t.which==1&&!n(t.target).is(r.dragSelectorExclude)&&!(n(t.target).closest(r.dragSelectorExclude).size()>0)&&h){for(t.preventDefault(),i=t.target;!n(i).is(r.dragSelector);){if(i==this)return;i=i.parentNode}n(i).attr("data-cursor",n(i).css("cursor")),n(i).css("cursor","move"),o=this,e=function(){f.dragStart.call(o,t),n(f.container).unbind("mousemove",e)},n(f.container).mousemove(e).mouseup(function(){n(f.container).unbind("mousemove",e),n(i).css("cursor",n(i).attr("data-cursor"))})}},dragStart:function(t){var f,e,l,o,s,h,c;i!=null&&i.draggedItem!=null&&i.dropItem(),i=u[n(this).attr("data-listidx")],i.draggedItem=n(t.target).closest("[data-listidx] > "+r.tagName),r.dragBeign.apply(i.draggedItem),i.draggedItem.attr("data-origpos",n(this).attr("data-listidx")+"-"+n(i.container).children().index(i.draggedItem)),f=parseInt(i.draggedItem.css("marginTop")),e=parseInt(i.draggedItem.css("marginLeft")),i.offset=i.draggedItem.offset(),i.offset.top=t.pageY-i.offset.top+(isNaN(f)?0:f)-1,i.offset.left=t.pageX-i.offset.left+(isNaN(e)?0:e)-1,r.dragBetween||(l=n(i.container).outerHeight()==0?Math.max(1,Math.round(.5+i.getItems().size()*i.draggedItem.outerWidth()/n(i.container).outerWidth()))*i.draggedItem.outerHeight():n(i.container).outerHeight(),i.offsetLimit=n(i.container).offset(),i.offsetLimit.right=i.offsetLimit.left+n(i.container).outerWidth()-i.draggedItem.outerWidth(),i.offsetLimit.bottom=i.offsetLimit.top+l-i.draggedItem.outerHeight()),o=i.draggedItem.height(),s=i.draggedItem.width(),r.tagName=="tr"?(i.draggedItem.children().each(function(){n(this).width(n(this).width())}),i.placeHolderItem=i.draggedItem.clone().attr("data-placeholder",!0),i.draggedItem.after(i.placeHolderItem),i.placeHolderItem.children().each(function(){n(this).css({borderWidth:0,width:n(this).width()+1,height:n(this).height()+1}).html("&nbsp;")})):(i.draggedItem.after(r.placeHolderTemplate),i.placeHolderItem=i.draggedItem.next().css({height:o,width:s}).attr("data-placeholder",!0)),r.tagName=="td"&&(h=i.draggedItem.closest("table").get(0),n("<table id='"+h.id+"' style='border-width: 0px;' class='dragSortItem "+h.className+"'><tr><\/tr><\/table>").appendTo("body").children().append(i.draggedItem)),c=i.draggedItem.attr("style"),i.draggedItem.attr("data-origstyle",c?c:""),i.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:o,width:s}),i.scroll={moveX:0,moveY:0,maxX:n(document).width()-n(window).width(),maxY:n(document).height()-n(window).height()},i.scroll.scrollY=window.setInterval(function(){if(r.scrollContainer!=window){n(r.scrollContainer).scrollTop(n(r.scrollContainer).scrollTop()+i.scroll.moveY);return}var t=n(r.scrollContainer).scrollTop();(i.scroll.moveY>0&&t<i.scroll.maxY||i.scroll.moveY<0&&t>0)&&(n(r.scrollContainer).scrollTop(t+i.scroll.moveY),i.draggedItem.css("top",i.draggedItem.offset().top+i.scroll.moveY+1))},10),i.scroll.scrollX=window.setInterval(function(){if(r.scrollContainer!=window){n(r.scrollContainer).scrollLeft(n(r.scrollContainer).scrollLeft()+i.scroll.moveX);return}var t=n(r.scrollContainer).scrollLeft();(i.scroll.moveX>0&&t<i.scroll.maxX||i.scroll.moveX<0&&t>0)&&(n(r.scrollContainer).scrollLeft(t+i.scroll.moveX),i.draggedItem.css("left",i.draggedItem.offset().left+i.scroll.moveX+1))},10),n(u).each(function(n,t){t.createDropTargets(),t.buildPositionTable()}),i.setPos(t.pageX,t.pageY),n(document).bind("mousemove",i.swapItems),n(document).bind("mouseup",i.dropItem),r.scrollContainer!=window&&n(window).bind("wheel",i.wheel)},setPos:function(t,u){var e=u-this.offset.top,o=t-this.offset.left,s,h,f;r.dragBetween||(e=Math.min(this.offsetLimit.bottom,Math.max(e,this.offsetLimit.top)),o=Math.min(this.offsetLimit.right,Math.max(o,this.offsetLimit.left))),s=this.draggedItem.offsetParent().not("body").offset(),s!=null&&(e-=s.top,o-=s.left),r.scrollContainer==window?(u-=n(window).scrollTop(),t-=n(window).scrollLeft(),u=Math.max(0,u-n(window).height()+5)+Math.min(0,u-5),t=Math.max(0,t-n(window).width()+5)+Math.min(0,t-5)):(h=n(r.scrollContainer),f=h.offset(),u=Math.max(0,u-h.height()-f.top)+Math.min(0,u-f.top),t=Math.max(0,t-h.width()-f.left)+Math.min(0,t-f.left)),i.scroll.moveX=t==0?0:t*r.scrollSpeed/Math.abs(t),i.scroll.moveY=u==0?0:u*r.scrollSpeed/Math.abs(u),this.draggedItem.css({top:e,left:o})},wheel:function(t){var u,f,e;i&&r.scrollContainer!=window&&(u=n(r.scrollContainer),f=u.offset(),t=t.originalEvent,t.clientX>f.left&&t.clientX<f.left+u.width()&&t.clientY>f.top&&t.clientY<f.top+u.height()&&(e=(t.deltaMode==0?1:10)*t.deltaY,u.scrollTop(u.scrollTop()+e),t.preventDefault()))},buildPositionTable:function(){var t=[];this.getItems().not([i.draggedItem[0],i.placeHolderItem[0]]).each(function(i){var r=n(this).offset();r.right=r.left+n(this).outerWidth(),r.bottom=r.top+n(this).outerHeight(),r.elm=this,t[i]=r}),this.pos=t},dropItem:function(){var e,f,t,o;if(i.draggedItem!=null)return e=i.draggedItem.attr("data-origstyle"),i.draggedItem.attr("style",e),e==""&&i.draggedItem.removeAttr("style"),i.draggedItem.removeAttr("data-origstyle"),i.styleDragHandlers(!0),r.vue?(f=n(i.placeHolderItem).index(),f>n(i.draggedItem).index()&&f--,i.draggedItem.attr("forvueIndex",f)):i.placeHolderItem.before(i.draggedItem),i.placeHolderItem.remove(),n("[data-droptarget], .dragSortItem").remove(),window.clearInterval(i.scroll.scrollY),window.clearInterval(i.scroll.scrollX),r.dragEnd.apply(i.draggedItem)==!1&&(t=i.draggedItem.attr("data-origpos").split("-"),o=n(u[t[0]].container).children().not(i.draggedItem).eq(t[1]),o.size()>0?o.before(i.draggedItem):t[1]==0?n(u[t[0]].container).prepend(i.draggedItem):n(u[t[0]].container).append(i.draggedItem)),i.draggedItem.removeAttr("data-origpos"),i.draggedItem.removeAttr("forvueIndex"),i.draggedItem=null,n(document).unbind("mousemove",i.swapItems),n(document).unbind("mouseup",i.dropItem),r.scrollContainer!=window&&n(window).unbind("wheel",i.wheel),!1},swapItems:function(t){var e,o,s,h,c;if(i.draggedItem==null)return!1;for(i.setPos(t.pageX,t.pageY),e=i.findPos(t.pageX,t.pageY),o=i,s=0;e==-1&&r.dragBetween&&s<u.length;s++)e=u[s].findPos(t.pageX,t.pageY),o=u[s];return e==-1?!1:(h=function(){return n(o.container).children().not(o.draggedItem)},c=h().not(r.itemSelector).each(function(){this.idx=h().index(this)}),f==null||f.top>i.draggedItem.offset().top||f.left>i.draggedItem.offset().left?n(o.pos[e].elm).before(i.placeHolderItem):n(o.pos[e].elm).after(i.placeHolderItem),c.each(function(){var t=h().eq(this.idx).get(0);this!=t&&h().index(this)<this.idx?n(this).insertAfter(t):this!=t&&n(this).insertBefore(t)}),n(u).each(function(n,t){t.createDropTargets(),t.buildPositionTable()}),f=i.draggedItem.offset(),!1)},findPos:function(n,t){for(var i=0;i<this.pos.length;i++)if(this.pos[i].left<n&&this.pos[i].right>n&&this.pos[i].top<t&&this.pos[i].bottom>t)return i;return-1},createDropTargets:function(){r.dragBetween&&n(u).each(function(){var u=n(this.container).find("[data-placeholder]"),t=n(this.container).find("[data-droptarget]");u.size()>0&&t.size()>0?t.remove():u.size()==0&&t.size()==0&&(r.tagName=="td"?n(r.placeHolderTemplate).attr("data-droptarget",!0).appendTo(this.container):n(this.container).append(i.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",!0)),i.placeHolderItem.attr("data-placeholder",!0))})}};o.init(),u.push(o)}),this},n.fn.dragsort.defaults={itemSelector:"",dragSelector:"",vue:!1,dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBeign:function(){},dragBetween:!1,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}})(jQuery)